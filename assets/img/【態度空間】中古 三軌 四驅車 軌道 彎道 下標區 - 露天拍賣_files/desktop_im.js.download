!function(t){function e(n){if(s[n])return s[n].exports;var i=s[n]={exports:{},id:n,loaded:!1};return t[n].call(i.exports,i,i.exports,e),i.loaded=!0,i.exports}var s={};return e.m=t,e.c=s,e.p="",e(0)}({0:function(t,e,s){var n=s("./d/components/rt_messenger.store.js"),i=/((?:https?:\/\/)?(?:\w+\.ruten\.com\.tw|\w+\.pchomepay\.com\.tw))/gi,o=/(\(.*?)?\b((?:https?):\/\/[-a-z0-9+&@#\/%?=~_()|!:,.;]*[-a-z0-9+&@#\/%=~_()|])/gi,a=["${","}"],r=new Vue,u=function(){var t=new Date,e=Number(localStorage.getItem("chatBoxWarningMsgTimestamp")),s=new Date(e);return localStorage.setItem("chatBoxWarningMsgTimestamp",Date.now()),s.toDateString()!==t.toDateString()}(),c=function(t){for(var e={},s=0;s<t.length;s++)for(var n in t[s])e[n]=t[s][n];return e},l=function I(t,e,s){if(!(s<=0)){var n=e-t.scrollLeft,i=n/s*10;setTimeout(function(){t.scrollLeft=t.scrollLeft+i,t.scrollLeft!=e&&I(t,e,s-10)},10)}},g=function(t,e){var s=e;s.showQuickReplyBarScrollLeftButton=!1,s.showQuickReplyBarScrollRightButton=!1,t.length>0&&Vue.nextTick(function(){var t=s.$refs["quick-reply-bar"],e=s.$refs["quick-reply-bar-container"];if(s.quickReplyBarScrollLeftRecord=[],t&&e){l(t,0,100);var n=parseInt(window.getComputedStyle(e).paddingLeft),i=parseInt(window.getComputedStyle(e).paddingRight),o=parseInt(window.getComputedStyle(t).marginLeft),a=e.offsetWidth-2*o-(n+i);t.scrollWidth>a&&a>0&&(s.showQuickReplyBarScrollRightButton=!0)}})},d={delimiters:a,data:{showChatBoxWarningMsg:u,showQuickReplyBarScrollLeftButton:!1,showQuickReplyBarScrollRightButton:!1,quickReplyBarScrollLeftRecord:[]},store:n,created:function(){},mounted:function(){var t=document.getElementsByClassName("rt-messenger-chat-box")[0];t&&t.addEventListener("scroll",this._loadChatHistory)},components:{"rt-messenger-msg":{template:"#rt_messenger_msg",delimiters:a,props:["userId","index","data","lastMsg","seenMsgTimestamp"],computed:{isFirstMsgOrNotSameDay:function(){var t=!this.data.loading&&!this.data.error;return!!t&&(0===this.index||new Date(this.lastMsg.time).toDateString()!=new Date(this.data.time).toDateString())},timeDividerString:function M(){var t=new Date,e=new Date,s=new Date(this.data.time);if(e.setDate(t.getDate()-1),t.toDateString()==s.toDateString())return"今天";if(e.toDateString()==s.toDateString())return"昨天";var n,M="",i=["日","一","二","三","四","五","六"];switch(t.getFullYear()>s.getFullYear()?n="year":(t.getMonth()+1>s.getMonth()+1||t.getDate()>s.getDate())&&(n="month"),n){case"year":M+=s.getFullYear()+"/";case"month":M+=s.getMonth()+1+"/",M+=s.getDate(),M+="("+i[s.getDay()]+")"}return M},sourceOther:function(){return this.userId!==this.data.userid},msg:function(){return this.isIllegalMsg?"對話內容不符合規定，系統已自動過濾！":this.msgUrlParser(this.data.msg)},msgSeen:function(){return!this.isIllegalMsg&&!this.sourceOther&&this.data.timestamp<this.seenMsgTimestamp},isIllegalMsg:function(){return"illegal"===this.data.type},isImgMsg:function(){return"img"===this.data.type},isGoodsInfoMsg:function(){return this.data.hasOwnProperty("pid")&&0!==this.data.pid.length},isTransInfoMsg:function(){return this.data.hasOwnProperty("oid")&&0!==this.data.oid.length},transStatusIsBlank:function(){return""===this.data.info.transStatus||"<br>"==this.data.info.transStatus.trim()},transLinkIsBlank:function(){return"#"===this.data.info.linkUrl},hasTransDetail:function(){return!this.transStatusIsBlank||!this.transLinkIsBlank},formatedTime:function(){var t=new Date(this.data.time),e=t.getHours(),s=t.getMinutes(),n=e>=12?"下午":"上午";return e%=12,e=e?e:12,s=s<10?"0"+s:s,n+" "+e+":"+s}},methods:{msgUrlParser:function(t){return i.lastIndex=0,o.lastIndex=0,i.test(t)?t.replace(o,function(t){return'<a href="'+t+'" target="_blank">'+t+"</a>"}):t},showPhotoLightBox:function(){this.$emit("show-photo-lightbox")},showMsgErrorOptionPanel:function(){this.$emit("show-msg-error-option-panel")}}},"rt-messenger-quick-reply-msg":{template:"#rt_messenger_quick_reply_msg",delimiters:a,props:["text"],methods:{addQuickReplyMsg:function(){this.$emit("quick-reply")}}}},watch:{"conversation.msgs":{handler:function(){var t=document.getElementsByClassName("rt-messenger-chat-box")[0],e=t.scrollHeight-t.scrollTop===t.clientHeight;(this.autoScrollChatBox||e)&&this._autoScrollChatBox(),this.$nextTick(function(){document.getElementsByClassName("rt-messenger-chat-box")[0].offsetHeight})},deep:!0},quickReplyMsgs:function(t){g(t,this)}},computed:c([Vuex.mapState(["userId","storage","conversation","quickReplyMsgs","autoScrollChatBox"]),Vuex.mapGetters(["conversationLoad","userIsOnline","disableInput","disableInputErrorText"])]),methods:{_autoScrollChatBox:function(){var t=this;Vue.nextTick(function(){setTimeout(function(){var e=t.$el.getElementsByClassName("rt-messenger-chat-box")[0];e.scrollTop=e.scrollHeight,t.$store.commit("disableAutoScrollChatBox")},0)})},_loadChatHistory:function(){var t=this.conversation.userId,e=document.getElementsByClassName("rt-messenger-chat-box")[0],s=e.scrollHeight>e.clientHeight,n=e.scrollHeight;s&&0===e.scrollTop&&!this.conversation.chatHistoryProcessing&&this.conversation.chatHistoryAvailable&&(e.scrollTop=10,this.$store.dispatch("initialChatHistoryTask",{userId:t,needMsgAmount:30}).then(function(){Vue.nextTick(function(){var t=e.scrollHeight-n;e.scrollTop=t})}))},_loadConversation:function(t){this.$store.dispatch("loadConversation",t),this._autoScrollChatBox()},_sendMsg:function(t){this.$store.dispatch("ajaxSendMsg",{userid:this.userId,to:[this.conversation.userId],type:"text",msg:t,time:"",oid:"",pid:""})},sendMsg:function(t){var e=t.target.value.trim();this.$store.dispatch("ajaxSendInfoMsgInQueue"),0!==e.length&&this._sendMsg(e),t.target.value="",this.autoResize(t)},sendMsgButton:function(){var t=document.getElementsByClassName("rt-messenger-input")[0],e=t.value.trim();this.$store.dispatch("ajaxSendInfoMsgInQueue"),0!==e.length&&this._sendMsg(e),t.value="",this.autoResize({target:t})},sendQuickReplyMsg:function(t){var e=this.$el.getElementsByClassName("rt-messenger-input")[0];e.value=t,this.autoResize({target:e})},resetPhotoUploadInput:function(){this.$el.getElementsByClassName("rt-messenger-photo-upload-input-form")[0].reset()},uploadPhoto:function(t){var e=t.target.files;e.length>0&&this.$store.dispatch("ajaxSendImgMsg",{userId:this.conversation.userId,files:e})},addNewLine:function(t){t.target.value=t.target.value+"\n"},autoResize:function(t){var e=t.target,s=this.MSG_INPUT_TEXT_AREA_MIN_HEIGHT,n=this.MSG_INPUT_TEXT_AREA_MIN_HEIGHT,i=this.MSG_INPUT_TEXT_AREA_MAX_HEIGHT;e.style.height=s+"px",e.scrollHeight<=i?(e.scrollHeight>n&&(s=e.scrollHeight),e.classList.remove("max-height")):(s=i,e.classList.add("max-height")),e.style.height=s+"px"},slideQuickReplyBar:function(t){var e=this.$refs["quick-reply-bar"],s=0;if("right"===t){var n=this.$refs["quick-reply-msg"],i=this.$refs["quick-reply-bar-container"],o=i.offsetWidth,a=parseInt(window.getComputedStyle(i).paddingLeft),r=parseInt(window.getComputedStyle(i).paddingRight),u=parseInt(window.getComputedStyle(e).marginLeft),c=e.scrollLeft,g=o-u-a-r+c;this.quickReplyBarScrollLeftRecord.push(c);for(var d=0;d<n.length;d++){var m=n[d].$el,h=parseInt(window.getComputedStyle(m).marginLeft);if(m.offsetLeft+m.offsetWidth-a>g){s=m.offsetLeft-h-u-a,l(e,e.scrollWidth-o<=s?e.scrollWidth:s,100),e.scrollWidth-o<=s&&(this.showQuickReplyBarScrollRightButton=!1),this.showQuickReplyBarScrollLeftButton=!0;break}}}else s=this.quickReplyBarScrollLeftRecord.pop(),l(e,s,100),this.showQuickReplyBarScrollRightButton=!0,0===this.quickReplyBarScrollLeftRecord.length&&(this.showQuickReplyBarScrollLeftButton=!1)},resetQuickReplyBar:function(){var t=this.$refs["quick-reply-bar"];t.scrollLeft=0,this.quickReplyBarScrollLeftRecord=[]},showMsgErrorOptionPanel:function(t){var e="text"===t.type?t.token:t.imageid;r.$emit("showMsgErrorOptionPanel",{userId:t.to[0],type:t.type,token:e})},showPhotoLightBox:function(t){r.$emit("showPhotoLightBox",t)}}};if(new Vue({el:".rt-messenger-inbox",delimiters:a,mixins:[VueClickaway.mixin],data:{inboxClose:"inboxClose"},store:n,filters:{unreadMsgCounter:function(t){return t<10?t:"9+"}},computed:c([Vuex.mapState(["inbox","conversation","messengerOn"]),Vuex.mapGetters(["unreadMsgNotification"])]),methods:{toggleInbox:function(){this.messengerOn&&(this.inboxClose=!this.inboxClose,r.$emit("initial"))},clickOutsideOfInbox:function(t){if(!this.inboxClose){var e=t.target;e.classList.contains("rt-messenger-inbox-area")||(this.inboxClose=!0)}},loadConversation:function(t){t!=this.conversation.userId&&r.$emit("loadConversation",t)}}}),document.getElementsByClassName("rt-store-btn-messenger").length>0&&new Vue({el:".rt-store-btn-messenger",delimiters:a,data:{userId:Cookies.get("bid_rid",{domain:"ruten.com.tw"})},methods:{loadTemporaryConversation:function(t){void 0!==this.userId?r.$emit("loadTemporaryConversation",t):alert("請先登入!")}}}),document.getElementsByClassName("item-info-owner").length>0&&new Vue({el:".item-info-owner",data:{userId:Cookies.get("bid_rid",{domain:"ruten.com.tw"})},methods:{sendGoodsInfoMsg:function(t,e){void 0!==this.userId?r.$emit("sendGoodsInfoMsg",t,e):alert("請先登入!")}}}),document.getElementsByClassName("mybid-table").length>0||document.getElementsByClassName("mybid-transaction").length>0)for(var m=document.getElementsByClassName("rt-messenger-icon-button"),h=function(t){var e=t.target.getAttribute("data-action"),s=t.target.getAttribute("data-userid"),n=t.target.getAttribute("data-type"),i=t.target.getAttribute("data-no"),o=t.target.getAttribute("data-gno");"trans"===e?r.$emit("sendTransInfoMsg",s,n,i):"goods"===e&&r.$emit("sendGoodsInfoMsg",s,o)},f=0;f<m.length;f++){var p=m[f];p.addEventListener("click",h,!1)}if(document.getElementsByClassName("rt-messenger").length>0){new Vue({el:".rt-messenger",mixins:[VueClickaway.mixin,d],data:{MAX_QUICK_REPLY_MSGS:20,MSG_INPUT_TEXT_AREA_MIN_HEIGHT:52,MSG_INPUT_TEXT_AREA_MAX_HEIGHT:100,showSettingPanel:!1,quickReplyEditMode:!1,quickReplyDraggingItemIndex:!1,quickReplyDataBackup:[],quickReplySettingPanelAddMode:!0,quickReplyEditingItemIndex:!1,quickReplyEditText:""},created:function(){var t=this;t.$store.dispatch("initial","PRELOAD"),window.onload=function(){t.$store.dispatch("setSettingPanelDefaultData"),t.$store.commit("setAutoReplyMsg",RT.context.autoReplyMsg),t.$store.commit("setQuickReplyMsgs",RT.context.quickReplyMsgs)},r.$on("loadConversation",t._loadConversation)},computed:c([Vuex.mapState(["inbox","inboxFilter","chatListLimit","messengerOn","autoReplyOn","quickReplyOn"]),Vuex.mapGetters(["chatList","inboxIsEmpty"]),{autoReplyMsg:{get:function(){return this.$store.state.autoReplyMsg},set:function(t){this.$store.commit("setAutoReplyMsg",t)}}}]),components:{"rt-messenger-chat-list-slot":{template:"#rt_messenger_chat_list_slot",delimiters:a,props:["title","unread"],computed:{newMessage:function(){return this.unread>0}},methods:{loadConversation:function(){this.$emit("load-conversation")},deleteConversation:function(){this.$emit("delete-conversation")}}}},methods:{_closeSettingPanel:function(){this.showSettingPanel=!1},_closeSettingPanelAndLoadConversation:function(t){this._closeSettingPanel(),this._loadConversation(t)},_deleteConversation:function(t){this._closeSettingPanel(),confirm("對話紀錄若刪除無法復原，請確認刪除？")&&this.$store.dispatch("deleteConversation",t)},filterInbox:function(t){var e=t.target.value.trim();this.$store.commit("setInboxFilter",e)},addFavoriteSeller:function(){this.$store.dispatch("ajaxSetFavoriteSeller")},toggleBlacklist:function(){this.$store.dispatch("ajaxSetBlacklist")},toggleSettingPanel:function(){this.showSettingPanel=!this.showSettingPanel},toggleMessenger:function(){this.$store.dispatch("ajaxToggleMessenger")},toggleAutoReply:function(){this.$store.dispatch("ajaxToggleAutoReply")},toggleQuickReply:function(){this.$store.dispatch("ajaxToggleQuickReply")},setAutoReplyMsg:function(){this.$store.dispatch("ajaxSetAutoReplyMsg")},editQuickReply:function(){this.quickReplyDataBackup=this.quickReplyMsgs.slice(0),this.quickReplyEditMode=!0},showQuickReplySettingPanel:function(){$("#rt_messenger_quick_reply_setting_panel").jqm({modal:!0,overlay:30}).jqmShow()},chatListShowMoreButton:function(){this.$store.dispatch("chatListShowMore")},setQuickReplyMsgs:function(){var t=this;t.$store.dispatch("ajaxSetQuickReplyMsgs").then(function(){r.$emit("showSetQuickReplyMsgResultPanel","SUCCESS"),t.quickReplyEditMode=!1},function(t){r.$emit("showSetQuickReplyMsgResultPanel","ERROR")})},revertQuickReplyData:function(){var t=this;r.$emit("showConfirmPopup",{msg:"確認要取消編輯並還原成原本的常用訊息設定嗎？",callback:function(e){e&&(t.$store.commit("setQuickReplyMsgs",t.quickReplyDataBackup),t.quickReplyEditMode=!1)}})},editQuickReplyText:function(t){this.quickReplyEditingItemIndex=t,this.quickReplySettingPanelAddMode=t>=this.quickReplyMsgs.length,this.quickReplyEditText=this.quickReplySettingPanelAddMode?"":this.quickReplyMsgs[t],$("#rt_messenger_quick_reply_setting_panel").jqm({modal:!0,overlay:30}).jqmShow()},setQuickReplyMsg:function(){0!==this.quickReplyEditText.length?this.$store.commit("editQuickReplyMsg",{index:this.quickReplyEditingItemIndex,text:this.quickReplyEditText}):this.quickReplySettingPanelAddMode||this.deleteQuickReply(this.quickReplyEditingItemIndex)},deleteQuickReply:function(t){this.$store.commit("deleteQuickReplyMsg",t)},allowDrop:function(t){t.preventDefault()},drop:function(t){t.preventDefault();var e=this.quickReplyDraggingItemIndex;this.$refs["quick-reply-text"][e].classList.remove("drag-target"),this.$refs["quick-reply-text"].forEach(function(t){t.classList.remove("old-hover-position")})},dragstart:function(t,e){this.quickReplyDraggingItemIndex=t,this.$refs["quick-reply-text"][t].classList.add("drag-target"),e.dataTransfer.setData("text/plain",t),e.dataTransfer.effectAllowed="move"},dragenter:function(t){var e=this.$refs["quick-reply-text"][t],s=this.$refs["quick-reply-text"][this.quickReplyDraggingItemIndex];s.classList.remove("drag-target"),e.classList.add("old-hover-position"),this.$store.commit("adjustQuickReplyMsgOrder",{originIndex:this.quickReplyDraggingItemIndex,targertIndex:t}),this.quickReplyDraggingItemIndex=t,this.$refs["quick-reply-text"][t].classList.add("drag-target")}}});var y=document.getElementById("rt_messenger_popup");y.parentNode.removeChild(y)}else new Vue({el:"#rt_messenger_popup",mixins:[VueClickaway.mixin,d],data:{MSG_INPUT_TEXT_AREA_MIN_HEIGHT:32,MSG_INPUT_TEXT_AREA_MAX_HEIGHT:80,showChatPopup:!0,showUserInfo:!0,userInfoTriggerTimer:!1,initialTriggerTimer:!1},created:function(){var t=this;t.initialTriggerTimer=setTimeout(function(){t.$store.dispatch("initial"),t.initialTriggerTimer=!1},3e4),r.$on("sendGoodsInfoMsg",this._sendGoodsInfoMsg),r.$on("sendTransInfoMsg",this._sendTransInfoMsg),r.$on("loadTemporaryConversation",this._loadTemporaryConversation),r.$on("loadConversation",this._initial),r.$on("initial",this._init)},computed:c([Vuex.mapState(["infoMsg"]),Vuex.mapGetters(["showInfoMsgInQueue","infoMsgInQueuehasTransDetail","infoMsgInQueueTransStatusIsBlank","infoMsgInQueueTransLinkIsBlank","infoMsgInQueueIsGoodsMsg"])]),watch:{conversationLoad:function(){var t=this;Vue.nextTick(function(){g(t.quickReplyMsgs,t)})},showQuickReplyBarScrollLeftButton:function(t){this.$refs["quick-reply-bar-container"];t?this.$refs["quick-reply-bar-container"].classList.add("padding-left"):this.$refs["quick-reply-bar-container"].classList.remove("padding-left")}},methods:{_init:function(){var t=this;t.initialTriggerTimer!==!1&&(clearTimeout(t.initialTriggerTimer),t.$store.dispatch("initial"),t.initialTriggerTimer=!1)},_initial:function(t){var e=this;e.initialTriggerTimer!==!1?(clearTimeout(e.initialTriggerTimer),e.$store.dispatch("initial").then(function(){e._loadConversation(t),e.showChatPopup=!0}),e.initialTriggerTimer=!1):(e._loadConversation(t),e.showChatPopup=!0)},_showChatPopup:function(){this.showChatPopup=!0},_loadTemporaryConversation:function(t){var e=this;e.initialTriggerTimer!==!1?(clearTimeout(e.initialTriggerTimer),e.$store.dispatch("initial").then(function(){e.$store.dispatch("checkStorageDataAndLoadConversation",t),e._showChatPopup()}),e.initialTriggerTimer=!1):(e.$store.dispatch("checkStorageDataAndLoadConversation",t),e._showChatPopup())},_sendGoodsInfoMsg:function(t,e){var s=this;s.initialTriggerTimer!==!1?(clearTimeout(s.initialTriggerTimer),s.$store.dispatch("initial").then(function(){s.$store.dispatch("sendInfoMsg",{userId:t,pid:e}),s._showChatPopup()}),s.initialTriggerTimer=!1):(s.$store.dispatch("sendInfoMsg",{userId:t,pid:e}),s._showChatPopup())},_sendTransInfoMsg:function(t,e,s){var n=this;n.initialTriggerTimer!==!1?(clearTimeout(n.initialTriggerTimer),n.$store.dispatch("initial").then(function(){n.$store.dispatch("sendInfoMsg",{userId:t,oid:e+":"+s}),n._showChatPopup()}),n.initialTriggerTimer=!1):(n.$store.dispatch("sendInfoMsg",{userId:t,oid:e+":"+s}),n._showChatPopup())},resetInfoMsgQueue:function(){this.$store.commit("resetInfoMsgQueue")},closeMessenger:function(){this.$store.dispatch("unloadConversation")}}});new Vue({el:"#rt_messenger_option_panel",delimiters:a,data:{panelContent:"",showOptionPanel:!1,confirmPopupMsg:"",confirmPopupCallback:function(t){this.showOptionPanel=!1,this.confirmPopupCustomCallback(t)},confirmPopupCustomCallback:function(){},errorMsgUserId:"",errorMsgType:"",errorMsgToken:"",setQuickReplyMsgsResult:!1},store:n,created:function(){r.$on("showMsgErrorOptionPanel",this._showMsgErrorOptionPanel),r.$on("showSetQuickReplyMsgResultPanel",this._showSetQuickReplyMsgResultPanel),r.$on("showConfirmPopup",this._showConfirmPopup)},computed:{isMsgError:function(){return"MSG_ERROR"===this.panelContent},isSetQuickReplyMsgResult:function(){return"SET_QUICK_REPLY_MSG_RESULT"===this.panelContent},isConfirmPopup:function(){return"CONFIRM_POPUP"===this.panelContent}},methods:{_showMsgErrorOptionPanel:function(t){this.errorMsgUserId=t.userId,this.errorMsgType=t.type,this.errorMsgToken=t.token,this.panelContent="MSG_ERROR",this.showOptionPanel=!0},_showSetQuickReplyMsgResultPanel:function(t){this.setQuickReplyMsgsResult="SUCCESS"===t,this.panelContent="SET_QUICK_REPLY_MSG_RESULT",this.showOptionPanel=!0},_showConfirmPopup:function(t){this.confirmPopupMsg=t.msg,this.confirmPopupCustomCallback=t.callback,this.panelContent="CONFIRM_POPUP",this.showOptionPanel=!0},reSendMsg:function(){"text"===this.errorMsgType?this.$store.dispatch("reSendMsg",{userId:this.errorMsgUserId,token:this.errorMsgToken}):"img"===this.errorMsgType&&this.$store.dispatch("reSendImgMsg",{userId:this.errorMsgUserId,token:this.errorMsgToken}),this.hideOptionPanel()},deleteMsg:function(){"text"===this.errorMsgType?this.$store.commit("removeTempMsg",{userId:this.errorMsgUserId,token:this.errorMsgToken}):"img"===this.errorMsgType&&this.$store.commit("removeTempImgMsg",{userId:this.errorMsgUserId,token:this.errorMsgToken}),this.hideOptionPanel()},hideOptionPanel:function(){this.panelContent="",this.showOptionPanel=!1}}}),new Vue({el:"#rt_messenger_lightbox",mixins:[VueClickaway.mixin],data:{showLightbox:!1,lightboxImgUrl:""},created:function(){r.$on("showPhotoLightBox",this._showPhotoLightBox)},methods:{_showPhotoLightBox:function(t){this.lightboxImgUrl=t,this.showLightbox=!0},hidePhotoLightBox:function(){this.showLightbox=!1}}}),document.body.addEventListener("click",function(t){var e,s=t.target;s.classList.contains("js-init-chat-window")&&(e=s.getAttribute("data-userid"),e&&""!==e&&r.$emit("loadTemporaryConversation",e))})},"./d/components/rt_messenger.store.js":function(t,e,s){function n(t){var e=t.split(" "),s=e[0],n=e[1],i=s.match(/[0-9]{4}\/[0-9]{2}\/[0-9]{2}/g)[0].split("/"),o=n.match(/[0-9]{2}:[0-9]{2}:[0-9]{2}/g)[0].split(":"),a=new Date(i[0],Number(i[1])-1,i[2],o[0],o[1],o[2]);return a.getTime()}function i(t){for(var e,s=Date.now(),n=s-t,i=["year","month","week","day","hour","minute"],o={year:"年",month:"個月",week:"周",day:"天",hour:"小時",minute:"分鐘"},a={year:31536e6,month:2592e6,week:6048e5,day:864e5,hour:36e5,minute:6e4},r=0;r<i.length;r++){var u=i[r],c=Math.floor(n/a[u]);if(c>0){e=c+o[u]+"前上線";break}}return e?e:"上線中"}var o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},a=s("./lib/rt_im.js");Vue.http.headers.post={"Content-Type":"application/x-www-form-urlencoded"},Vue.http.interceptors.push(function(t,e){t.credentials=!0,t.emulateJSON=!0,e()});var r=RT.config.alert_host+"/rutenim/accinfo.php",u=RT.config.alert_host+"/rutenim/transinfo.php",c=RT.config.alert_host+"/rutenim/goodsinfo.php",l=15,g=new Date,d=3e5,m=300,h=m,f=20,p=f;sessionStorage&&sessionStorage.M_CHAT_LIST_SIZE&&Number(sessionStorage.M_CHAT_LIST_SIZE)>f&&(f=sessionStorage.M_CHAT_LIST_SIZE);var y=Cookies.get("bid_rid"),I=Vue.http,M=function(){function t(t){return t&&"string"==typeof t&&(t=t.replace(/<script[^>]*>([\S\s]*?)<\/script>/gim,""),t=t.replace(/<\/?\w(?:[^"'>]|"[^"]*"|'[^']*')*>/gim,""),e.innerHTML=t,t=e.textContent,e.textContent=""),t}var e=document.createElement("div");return t}(),v=function(){function t(t){return String("0"+t).slice(-2)}return function(e){var s=new Date(e),n=s.getFullYear(),i=t(s.getMonth()+1),o=t(s.getDate()),a=t(s.getHours()),r=t(s.getMinutes()),u=t(s.getSeconds());return n+"/"+i+"/"+o+" "+a+":"+r+":"+u}}(),k=function(){var t="im_favorlist_cache_v2",e=void 0!==y&&null!==y,s=function(){var s=Cookies.getJSON(t),n="object"===("undefined"==typeof s?"undefined":o(s))&&null!==typeof s?s:{};return e&&n.hasOwnProperty(y)?n[y]:{}},n=function(e){var s=new Date((new Date).getTime()+3e5),n={};n[y]=e,Cookies.set(t,n,{domain:".ruten.com.tw",expires:s})};return{update:function(t){var e=s();for(var i in e)if(t[i]){var o=Math.floor(t[i][1]),a=e[i][1];o>=a&&(delete e[i],n(e))}},updateByUserId:function(t,e){var i=s(),o=e.unreadMsg,a=Math.floor(e.lastChatTimestamp);(void 0===i[t]||a>=i[t][1])&&(i[t]=[o,a],n(i))}}}(),S=new Vuex.Store({state:{userId:y,userStatus:"",inbox:[],inboxFilter:"",storage:{},conversation:{},infoMsg:{},infoMsgCache:{},autoReplyMsg:"",quickReplyMsgs:[],settingPanelDataIsReady:!1,finishRetrieveMsgInBuffer:!1,userIMStatusRefreshTask:!1,autoScrollChatBox:!1,forceScrollChatBox:!1,messengerOn:!0,autoReplyOn:!1,quickReplyOn:!0,chatListLimit:0,showMoreChatListAmount:0,chatListIsLoading:!0,today:(new Date).toLocaleDateString()},getters:{isLogin:function(t){return void 0!==t.userId&&null!==t.userId},chatList:function(t){if(""!==t.inboxFilter){var e=new RegExp(t.inboxFilter);return t.inbox.filter(function(t){return t&&(t.storeName.match(e)||t.userNick.match(e))})}return t.inbox.slice(0,t.chatListLimit)},inboxIsEmpty:function(t){return 0===t.inbox.length},unreadMsgNotification:function T(t){for(var T=!1,e=0;e<t.inbox.length;e++){var s=t.inbox[e];if(s&&s.unreadMsg>0){T=!0;break}}return T},unreadMsgCounter:function R(t){var R=0;return t.inbox.forEach(function(t){R+=Number(t.unreadMsg)}),R},conversationLoad:function(t){return 0!==Object.keys(t.conversation).length},showInfoMsgInQueue:function(t){return 0!==Object.keys(t.infoMsg).length&&t.infoMsg.additionalInfoIsReady},infoMsgInQueuehasTransDetail:function(t){var e=t.infoMsg;if(e.hasOwnProperty("info")){var s=e.hasOwnProperty("oid")&&0!==e.oid.length,n=""===e.info.transStatus||"<br>"==e.info.transStatus.trim(),i="#"===e.info.linkUrl;return s&&(!n||!i)}return!1},infoMsgInQueueTransStatusIsBlank:function(t){var e=t.infoMsg;return!e.hasOwnProperty("info")||(""===e.info.transStatus||"<br>"==e.info.transStatus.trim())},infoMsgInQueueTransLinkIsBlank:function(t){var e=t.infoMsg;return!e.hasOwnProperty("info")||"#"===e.info.linkUrl},m_InfoMsgInQueueTransLink:function(t){var e=t.infoMsg;if(""!==e.pid)return RT.config.mobile_host+"/goods/show.php?g="+e.pid;if(""!==e.oid){var s=e.oid.split(":"),n=(s[0],s[1]);return RT.config.mybid_host+"/mobile/buy_list_detail.php?tno="+n}},infoMsgInQueueIsGoodsMsg:function(t){return""!==t.infoMsg.pid},userIsOnline:function(t){return"上線中"===t.conversation.userIMStatus},disableInput:function(t){var e=t.conversation.isInBlacklist,s="N"===t.conversation.userStatus,n="A"===t.conversation.userStatus,i="N"===t.userStatus,o="A"===t.userStatus,a="newContact"===t.conversation.userStatus;return e||s||n||i||o||a},disableInputErrorText:function(t){var e=t.conversation.isInBlacklist,s="N"===t.conversation.userStatus,n="A"===t.conversation.userStatus,i="N"===t.userStatus,o="A"===t.userStatus,a="newContact"===t.conversation.userStatus;return e?"您已將該使用者設為黑名單，無法與對方使用露露通":s?"此會員目前不使用露露通":n?"此會員帳號被暫時停權":i?"請先完成您的註冊才能使用露露通":o?"您目前被暫時停權，無法使用露露通":a?"T"===t.userStatus?"您目前被暫時停權，無法與新聯絡人建立對話訊息":"此會員被暫時停權，無法與新聯絡人建立對話訊息":void 0},currentImer:function(t){var e=t.conversation;if(0===Object.keys(e).length)return{};var s={};return e.msgs.forEach(function(t,e){var n=t.time.split(" ")[0];s[n]||(s[n]=[]),t.index=e,s[n].push(t)}),e.msgByDate=s,e}},mutations:{addChatListSize:function(t,e){t.chatListLimit+=e},setUserSelfStatus:function(t,e){t.userStatus=e},setUserInfo:function(t,e){var s=t.storage[e.userId];s.userNick=e.userNick,s.storeName=e.storeName,s.userCredit=e.userCredit,s.userStatus=e.userStatus,s.isInBlacklist=e.isInBlacklist},setUserIMStatus:function(t,e){var s=t.storage[e.userId];s.userIMStatus=e.userIMStatus,t.userIMStatusRefreshTask=e.userIMStatusRefreshTask},markUserAsNewContact:function(t,e){t.storage[e].userStatus="newContact"},setAutoReplyMsg:function(t,e){t.autoReplyMsg=e},setQuickReplyMsgs:function(t,e){t.quickReplyMsgs=e},editQuickReplyMsg:function(t,e){var s=e.index,n=e.text;s>=t.quickReplyMsgs.length?t.quickReplyMsgs.push(n):Vue.set(t.quickReplyMsgs,s,n)},deleteQuickReplyMsg:function(t,e){t.quickReplyMsgs.splice(e,1)},adjustQuickReplyMsgOrder:function(t,e){var s=t.quickReplyMsgs.splice(e.originIndex,1)[0];t.quickReplyMsgs.splice(e.targertIndex,0,s)},setChatHistoryDate:function(t,e){t.storage[e.userId].chatHistoryDate=e.date},setMessengerSwitch:function(t,e){t.messengerOn=e},setAutoReplySwitch:function(t,e){t.autoReplyOn=e},setQuickReplySwitch:function(t,e){t.quickReplyOn=e},addIntoInbox:function(t,e){t.storage[e]&&t.inbox.push(t.storage[e]),t.inbox.sort(function(t,e){return e.lastChatTimestamp-t.lastChatTimestamp})},setInboxFilter:function(t,e){t.inboxFilter=e},createStorageData:function(t,e){t.storage[e.userId]={userId:e.userId,unreadMsg:e.unreadMsg,lastChatTimestamp:e.lastChatTimestamp,userNick:e.userNick,storeName:null===e.storeName||void 0===e.storeName||""===e.storeName?e.userNick:e.storeName,userCredit:e.userCredit,userStatus:e.userStatus,userIMStatus:"",isInBlacklist:e.isInBlacklist,isFavoriteSeller:!1,msgs:[],infoMsgsQueue:[],chatHistoryDate:g.valueOf()>1e3*e.lastChatTimestamp?g:new Date(1e3*e.lastChatTimestamp),msgUniqueKeyList:{},seenMsgTimestamp:0,chatHistoryProcessing:!1,chatHistoryAvailable:!0}},createTempStorageData:function(t,e){t.storage[e.userId]={userId:e.userId,unreadMsg:e.unreadMsg,lastChatTimestamp:e.lastChatTimestamp,userNick:"",storeName:"",userCredit:0,userStatus:"",userIMStatus:"",isInBlacklist:!1,isFavoriteSeller:!1,msgs:[],infoMsgsQueue:[],chatHistoryDate:g.valueOf()>1e3*e.lastChatTimestamp?g:new Date(1e3*e.lastChatTimestamp),msgUniqueKeyList:{},seenMsgTimestamp:0,chatHistoryProcessing:!1,chatHistoryAvailable:!0}},loadConversation:function(t,e){t.conversation=t.storage[e]},unloadConversation:function(t){t.conversation={}},addFavoriteSeller:function(t,e){t.storage[e].isFavoriteSeller=!0},toggleBlacklist:function(t,e){t.storage[e].isInBlacklist=!t.storage[e].isInBlacklist},deleteContactInInbox:function(t,e){t.inbox=t.inbox.filter(function(t){return t&&t.userId!==e})},addMsg:function(t,e){var s=t.storage[e.userId],n=String(e.msg.userid+"_"+e.msg.timestamp+"_"+e.msg.oid+e.msg.pid);s.msgs.push(e.msg),s.msgs.sort(function(t,e){return t.timestamp-e.timestamp}),s.msgUniqueKeyList[n]=!0},updateTempImgMsg:function(t,e){for(var s=e.userId,n=e.msg,i=t.storage[s].msgs,o=t.storage[s],a=String(n.userid+"_"+n.timestamp),r=0;r<i.length;r++){var u=i[r];if(u.imageid===n.imageid){u.time=n.time,u.timestamp=n.timestamp,u.msg=n.msg,u.loading=!1,u.error=!1;break}}o.msgs.sort(function(t,e){return t.timestamp-e.timestamp}),o.msgUniqueKeyList[a]=!0},removeTempMsg:function(t,e){for(var s=e.userId,n=e.token,i=t.storage[s].msgs,o=0;o<i.length;o++)if(i[o].token===n){i.splice(o,1);break}},removeTempImgMsg:function(t,e){for(var s=e.userId,n=e.token,i=t.storage[s].msgs,o=0;o<i.length;o++)if(i[o].imageid===n){i.splice(o,1);break}},markMsgLoadingDone:function(t,e){e.loading=!1},markMsgError:function(t,e){e.error=!0},markMsgErrorByToken:function(t,e){for(var s=e.userId,n=e.token,i=t.storage[s].msgs,o=0;o<i.length;o++){var a=i[o];if(a.imageid===n){a.loading=!1,a.error=!0;break}}},deleteMsgs:function(t,e){for(var s=e.userId,n=e.timestamp,i=t.storage[s].msgs,o=-1,a=0;a<i.length;a++){var r=i[a];if(r.timestamp>n){o=a;break}}o===-1?t.storage[s].msgs=[]:t.storage[s].msgs=t.storage[s].msgs.slice(o)},queueInfoMsg:function(t,e){t.infoMsg=e},resetInfoMsgQueue:function(t){t.infoMsg={}},addUnreadCounter:function(t,e){t.storage[e].unreadMsg++,k.updateByUserId(e,{unreadMsg:t.storage[e].unreadMsg,lastChatTimestamp:t.storage[e].lastChatTimestamp})},resetUnreadMsgCounter:function(t,e){t.storage[e].unreadMsg=0,k.updateByUserId(e,{unreadMsg:0,lastChatTimestamp:t.storage[e].lastChatTimestamp})},updateSeenMsgTimestamp:function(t,e){var s=e.userId,n=e.timestamp;t.storage[s].seenMsgTimestamp=n},updateLastChatTimestamp:function(t,e){var s=e.userId;t.storage[s].lastChatTimestamp=e.lastChatTimestamp,t.inbox.sort(function(t,e){return e.lastChatTimestamp-t.lastChatTimestamp})},queueInfoMsgRequestTasks:function(t,e){t.storage[e.userId].infoMsgsQueue.push(e.msg)},clearInfoMsgQueue:function(t,e){t.storage[e].infoMsgsQueue=[]},addInfoMsgData:function(t,e){var s=e.msg.info,n=e.info;s.goodsImgUrl=n.goodsImgUrl,s.goodsName=n.goodsName,s.price=n.price,s.transStatus=n.transStatus,s.linkUrl=n.linkUrl},saveInfoMsgCache:function(t,e){t.infoMsgCache[e.key]=e.data},markInfoMsgDataIsReady:function(t,e){e.additionalInfoIsReady=!0},markChatHistoryUnavailable:function(t,e){t.storage[e].chatHistoryAvailable=!1},markChatHistoryProcessing:function(t,e){t.storage[e].chatHistoryProcessing=!0},markChatHistoryRequestDone:function(t,e){t.storage[e].chatHistoryProcessing=!1},enableAutoScrollChatBox:function(t){t.autoScrollChatBox=!0},disableAutoScrollChatBox:function(t){t.autoScrollChatBox=!1},enableForceScrollChatBox:function(t){t.forceScrollChatBox=!0},disableForceScrollChatBox:function(t){t.forceScrollChatBox=!1},resetData:function(t){t.storage={},t.conversation={},t.inbox=[],t.finishRetrieveMsgInBuffer=!1,t.messengerOn=!1,RT.context.messengerOn=!1,clearTimeout(t.userIMStatusRefreshTask)},markFinishRetrieveMsgInBuffer:function(t){t.finishRetrieveMsgInBuffer=!0},markSettingPanelDataReady:function(t){t.settingPanelDataIsReady=!0},markChatListLoadingDone:function(t){t.chatListIsLoading=!1}},actions:{initial:function(t,e){return new Promise(function(s,n){if(t.getters.isLogin){var i=t.state,o=t.commit,r=t.dispatch;i.chatListLimit=m,i.showMoreChatListAmount=h,r("ajaxGetUserAccountInfo",i.userId).then(function(t){o("setUserSelfStatus",t.userStatus)},function(t){}),a.getFavorList().then(function(t){if(t.body instanceof Array){var n=t.body,a=(i.userId,[]);"PRELOAD"!==e&&r("ajaxGetQuickReplyMsgsSetting");var u={};n.sort(function(t,e){return e.last_chat_time-t.last_chat_time}),n.forEach(function(t){a.push(r("createStorageData",t)),u[t.id]=[t.unread_count,t.last_chat_time]}),k.update(u),Promise.all(a).then(function(){r("ajaxReceiveMsg").then(function(){i.inbox;o("markFinishRetrieveMsgInBuffer")},function(t){}),s(),"PRELOAD"===e&&i.inbox.length>0&&setTimeout(function(){r("loadConversation",i.inbox[0].userId)},700)})}},function(e){t.commit("setMessengerSwitch",!1)})}})},initialMobileChatList:function(t){if(t.getters.isLogin){var e=t.state,s=t.commit,n=t.dispatch;e.chatListLimit=f,e.showMoreChatListAmount=p,a.getFavorList().then(function(t){if(t.body instanceof Array){var i=t.body,o=e.userId,a=[];n("ajaxGetUserAccountInfo",o).then(function(t){s("setUserSelfStatus",t.userStatus)},function(t){});
var r={};i.sort(function(t,e){return e.last_chat_time-t.last_chat_time}),i.forEach(function(t){a.push(n("createStorageData",t)),r[t.id]=[t.unread_count,t.last_chat_time]}),k.update(r),Promise.all(a).then(function(){s("markChatListLoadingDone"),n("ajaxReceiveMsg").then(function(){s("markFinishRetrieveMsgInBuffer")},function(t){});for(var t=e.inbox,i=0;i<t.length&&i<e.chatListLimit;i++){var o=t[i];n("initialChatHistoryTask",{userId:o.userId,needMsgAmount:1,processOnlyOneMsg:!0})}})}},function(t){s("setMessengerSwitch",!1),s("markChatListLoadingDone")})}},initialMobileMessenger:function(t,e){if(t.getters.isLogin){var s=t.state,n=t.commit,i=t.dispatch;a.getFavorList().then(function(t){if(t.body instanceof Array){var o=t.body,a=s.userId,r=e.userId,u=e.oid,c=e.pid;i("ajaxGetUserAccountInfo",a).then(function(t){n("setUserSelfStatus",t.userStatus)},function(t){}),i("ajaxGetQuickReplyMsgsSetting");var l={};o.forEach(function(t){l[t.id]=[t.unread_count,t.last_chat_time]}),k.update(l);var g=o.filter(function(t){return t.id==r})[0];g&&i("createStorageData",g),i("ajaxReceiveMsg").then(function(){n("markFinishRetrieveMsgInBuffer")},function(t){}),setTimeout(function(){""!==u?i("sendInfoMsg",{userId:r,oid:u}):""!==c?i("sendInfoMsg",{userId:r,pid:c}):i("checkStorageDataAndLoadConversation",r)},700)}},function(t){n("setMessengerSwitch",!1)})}},ajaxGetUserAccountInfo:function(t,e){return new Promise(function(t,s){I.post(r,{ctrl_rowid:JSON.stringify({ctrl_rowid:e})}).then(function(n){n=n.body,n.hasOwnProperty("err")?s(n):t({userId:e,userNick:n.user_nick,storeName:n.board_name,userCredit:n.user_credit,userStatus:n.user_status,isInBlacklist:"Y"===n.black_status})},s)})},ajaxGetUserIMStat:function(t,e){var s=t.state,o=t.commit,r=t.dispatch,u=e.userId;clearTimeout(s.userIMStatusRefreshTask),a.getStat([u]).then(function(t){if(200===t.status){var s=n(t.body[0].time),a=i(s),c=setTimeout(function(){r("ajaxGetUserIMStat",{userId:u})},d);o("setUserIMStatus",{userId:u,userIMStatus:a,userIMStatusRefreshTask:c}),e.checkMessengerSwitch&&alert("此會員目前不使用露露通!")}},function(t){400===t.status&&(o("setMessengerSwitch",!1),o("resetData"),a.stopReceiveMsg())})},ajaxAddFavorList:function(t,e){return new Promise(function(s,n){a.addFavorList([e]).then(function(t){201===t.status&&s()},function(s){400===s.status&&t.dispatch("ajaxGetUserIMStat",{userId:e,checkMessengerSwitch:!0})})})},ajaxDeleteFavorList:function(t,e){a.deleteFavorList([e]).then(function(t){},function(t){})},ajaxGetAutoReplyMsgSetting:function(t){a.getAutoReplyMsg().then(function(e){t.commit("setAutoReplyMsg",JSON.parse(e.body))},function(t){})},ajaxGetQuickReplyMsgsSetting:function(t){a.getQuickReplyMsg().then(function(e){t.commit("setQuickReplyMsgs",e.body)},function(){})},ajaxGetTransInfo:function(t,e){var s=e.oid.split(":"),n=s[0],i=s[1];I.post(u,{type:JSON.stringify({type:n}),no:JSON.stringify({no:i})}).then(function(s){var o=s.body;s.hasOwnProperty("err")||(t.commit("addInfoMsgData",{msg:e,info:{goodsImgUrl:o.img,goodsName:o.g_name,price:o.amount,transStatus:void 0!==o.trans_status?M(o.trans_status.trim()):"",linkUrl:"t"===n?RT.config.mybid_host+"/master/view_transaction.php?tno="+i:"#"}}),t.commit("markInfoMsgDataIsReady",e))},function(t){})},ajaxGetGoodsInfo:function(t,e){var s=e.pid;I.post(c,{g_no:JSON.stringify({g_no:s})}).then(function(s){var n=s.body;s.hasOwnProperty("err")||(t.commit("addInfoMsgData",{msg:e,info:{goodsImgUrl:n.img,goodsName:n.g_name,price:n.price,transStatus:"",linkUrl:RT.config.goods_host+"/item/show?"+e.pid}}),t.commit("markInfoMsgDataIsReady",e))},function(t){})},ajaxSetFavoriteSeller:function(t){var e=t.state.conversation.userId,s=t.state.conversation.userNick;I.post(RT.config.mybid_host+"/api/addFavoriteSeller.php",{seller_user_nick:s,action:"add"}).then(function(s){s=s.body,"NOSELLER"===s.status?alert("賣家不存在!"):"OVERFLOW"===s.status?alert("最愛賣家清單已達上限!"):"GO_ON"===s.status||"EXISTS"===s.status?t.commit("addFavoriteSeller",e):alert("系統忙碌中，請稍後再試!")},function(t){alert("系統忙碌中，請稍後再試!")})},ajaxSetBlacklist:function(t){var e=t.state.conversation.userId,s=t.state.conversation.userNick,n=t.state.conversation.isInBlacklist;I.post(RT.config.mybid_host+"/api/addBlackUser.php",{p_user_nick:s,action:n?"cancel":"add"}).then(function(i){if(i.body.status){t.commit("toggleBlacklist",e);var o=n?"移除":"加入";alert("已將"+s+o+"賣場黑名單!")}else"NOTEXIST"===i.body.error?alert("您已被對方封鎖，尚無解除黑名單權限!"):alert("系統忙碌中，請稍後再試!")},function(t){alert("系統忙碌中，請稍後再試!")})},m_ajaxSetFavoriteSeller:function(t){return new Promise(function(e,s){var n=t.state.conversation.userId,i=t.state.conversation.userNick;I.post(RT.config.mybid_host+"/api/addFavoriteSeller.php",{seller_user_nick:i,action:"add"}).then(function(o){o=o.body,"NOSELLER"===o.status?s("賣家不存在!"):"OVERFLOW"===o.status?s("最愛賣家清單已達上限!"):"GO_ON"===o.status||"EXISTS"===o.status?(t.commit("addFavoriteSeller",n),e("已將"+i+"加入最愛賣家!")):s("系統忙碌中，請稍後再試!")},function(t){s("系統忙碌中，請稍後再試!")})})},m_ajaxSetBlacklist:function(t){return new Promise(function(e,s){var n=t.state.conversation.userId,i=t.state.conversation.userNick,o=t.state.conversation.isInBlacklist;I.post(RT.config.mybid_host+"/api/addBlackUser.php",{p_user_nick:i,action:o?"cancel":"add"}).then(function(a){if(a.body.status){t.commit("toggleBlacklist",n);var r=o?"移除":"加入";e("已將"+i+r+"賣場黑名單!")}else s("NOTEXIST"===a.body.error?"您已被對方封鎖，尚無解除黑名單權限!":"系統忙碌中，請稍後再試!")},function(t){s("系統忙碌中，請稍後再試!")})})},ajaxToggleMessenger:function(t){I.post("ajax_im_active.php",{ctrl_rowid:t.state.userId,active:t.state.messengerOn?"N":"Y"}).then(function(e){e.body.status?(t.commit("setMessengerSwitch",!t.state.messengerOn),t.state.messengerOn?t.dispatch("initial","PRELOAD"):(a.stopReceiveMsg(),t.commit("resetData"))):alert("系統忙碌中，請稍後再試!")},function(t){alert("系統忙碌中，請稍後再試!")})},ajaxToggleAutoReply:function(t){I.post("ajax_auto_message.php",{ctrl_rowid:t.state.userId,type:"auto",auto_message:t.state.autoReplyOn?"N":"Y"}).then(function(e){e.body.status?t.commit("setAutoReplySwitch",!t.state.autoReplyOn):alert("系統忙碌中，請稍後再試!")},function(t){alert("系統忙碌中，請稍後再試!")})},ajaxSetAutoReplyMsg:function(t){I.post("ajax_auto_message.php",{ctrl_rowid:t.state.userId,type:"text",message_text:t.state.autoReplyMsg}).then(function(t){t.body.status?alert("自動回覆訊息儲存成功!"):alert("系統忙碌中，請稍後再試!")},function(t){alert("系統忙碌中，請稍後再試!")})},ajaxToggleQuickReply:function(t){I.post("ajax_set_reply.php",{ctrl_rowid:t.state.userId,type:"switch","switch":t.state.quickReplyOn?"N":"Y"}).then(function(e){e.body.status?t.commit("setQuickReplySwitch",!t.state.quickReplyOn):alert("系統忙碌中，請稍後再試!")},function(t){alert("系統忙碌中，請稍後再試!")})},ajaxSetQuickReplyMsgs:function(t){return new Promise(function(e,s){I.post("ajax_set_reply.php",{ctrl_rowid:t.state.userId,type:"text",reply_text:JSON.stringify(t.state.quickReplyMsgs)}).then(function(t){t.body.status?e(t):s(t)},s)})},ajaxReceiveMsg:function(t){return new Promise(function(e,s){a.receiveMsg().then(function(s){var n=t.dispatch,i=[];s.forEach(function(t){i.push(n("processMsg",{msg:t,isNewMsg:!0}))}),Promise.all(i).then(function(){n("ajaxReceiveMsg"),e()},function(t){})},s)})},ajaxSendMsg:function(t,e){var s,n,i=t.commit,o=t.dispatch,r=e.to[0],u=Date.now(),c=u+"_"+Math.floor(1e4*Math.random()+1),l={userid:e.userid,to:e.to,type:"text",msg:e.msg,time:"",oid:e.oid,pid:e.pid},g={userid:e.userid,to:e.to,type:"text",msg:e.msg,time:"",oid:e.oid,pid:e.pid};e.hasOwnProperty("additionalInfoIsReady")&&(g.info=e.info,g.additionalInfoIsReady=e.additionalInfoIsReady),s=setTimeout(function(){g.token=c,g.timestamp=Number(String(u).substring(0,10)),g.time=v(u),g.loading=!0,g.error=!1,i("enableAutoScrollChatBox"),i("addMsg",{userId:r,msg:g}),n=setTimeout(function(){i("markMsgLoadingDone",g),i("markMsgError",g)},5e3)},1e3),a.sendMsg(r,l).then(function(t){201===t.status&&(clearTimeout(s),clearTimeout(n),i("removeTempMsg",{userId:r,token:c}))},function(e){400===e.status?(clearTimeout(s),clearTimeout(n),i("removeTempMsg",{userId:r,token:c}),o("ajaxAddFavorList",r).then(function(){o("ajaxSendMsg",l)},function(){})):401===e.status?alert("請先登入!"):423===e.status?(clearTimeout(s),clearTimeout(n),i("removeTempMsg",{userId:r,token:c}),t.state.storage[r].isInBlacklist?alert("您已將此會員設為黑名單，無法與對方使用露露通"):alert("您已被此會員設為黑名單，無法與對方使用露露通")):(i("markMsgLoadingDone",g),i("markMsgError",g))})},ajaxSendImgMsg:function(t,e){for(var s=t.commit,n=t.dispatch,i=e.userId,o=e.files,r=function(e,o,r){var u=o.timestamp,c=o.token,l=new FileReader;l.addEventListener("load",function(o){var l={imageid:c,file:r,msg:o.target.result,oid:"",pid:"",type:"img",time:v(u),timestamp:Number(String(u).substring(0,10)),to:[i],userid:t.state.userId,loading:!0,error:!1};s("enableAutoScrollChatBox"),s("addMsg",{userId:i,msg:l}),e.append("file",r),a.sendImgMsg(i,c,e).then(function(t){201!==t.status&&s("markMsgErrorByToken",{userId:i,token:c})},function(o){400===o.status?n("ajaxAddFavorList",i).then(function(){a.sendImgMsg(i,c,e).then(function(){},function(t){s("markMsgErrorByToken",{userId:i,token:c})})},function(){}):401===o.status?alert("請先登入!"):423===o.status?(s("removeTempImgMsg",{userId:i,token:c}),t.state.storage[i].isInBlacklist?alert("您已將此會員設為黑名單，無法與對方使用露露通"):alert("您已被此會員設為黑名單，無法與對方使用露露通")):s("markMsgErrorByToken",{userId:i,token:c})})}),l.readAsDataURL(r)},u=0;u<o.length;u++){var c=new FormData,l=Date.now(),g=l+"_"+Math.floor(1e4*Math.random()+1),d=o[u];r(c,{timestamp:l,token:g},d)}},ajaxSendInfoMsgInQueue:function(t){Object.keys(t.state.infoMsg).length>0&&(t.dispatch("ajaxSendMsg",t.state.infoMsg),t.commit("resetInfoMsgQueue"))},ajaxSendMsgSeen:function(t,e){a.msgSeen(e).then(function(t){},function(t){})},ajaxSendDeleteMsg:function(t,e){a.deleteMsg(e).then(function(t){},function(t){})},ajaxGetChatHistory:function(t,e){return new Promise(function(t,s){a.getChatHistory(e.userId,e.q).then(function(e){t(e.body.reverse())},s)})},getChatHistory:function(t,e){return new Promise(function(s,n){var i=t.state,o=t.commit,a=t.dispatch,r=e.userId,u=e.needMsgAmount,c=function l(t){var e=function(t){return String("0"+t).slice(-2)},c=i.storage[r].chatHistoryDate,g=(c.getFullYear()+e(c.getMonth()+1)+e(c.getDate()),new Date(c.valueOf()));g.setDate(g.getDate()+1),a("ajaxGetChatHistory",{userId:r,q:Math.floor(g.valueOf()/1e3)}).then(function(e){for(var n=-1,i=0;i<e.length;i++)if("delete"===e[i].type){n=i;break}if(n!==-1)e=e.slice(0,n),o("markChatHistoryUnavailable",r),s(t.chatHistory.concat(e));else if(0===e.length)o("markChatHistoryUnavailable",r),s(t.chatHistory);else{var a=10===String(Math.floor(e[e.length-1].timestamp)).length?1e3*e[e.length-1].timestamp:e[e.length-1].timestamp;newDate=new Date(a),newDate.setDate(newDate.getDate()-1),o("setChatHistoryDate",{userId:r,date:newDate}),t.chatHistory=t.chatHistory.concat(e),t.chatHistory.filter(function(t){return"read"!==t.type}).length>=u?s(t.chatHistory):l(t)}},n)};c({time:i.storage[r].chatHistoryDate,chatHistory:[]})})},initialChatHistoryTask:function(t,e){return new Promise(function(s,n){var i=t.commit,o=t.dispatch,a=e.userId,r=(e.needMsgAmount,t.state.storage[a].chatHistoryDate,t.state.storage[a].chatHistoryAvailable);r?(i("markChatHistoryProcessing",a),o("getChatHistory",{userId:e.userId,chatHistory:[],needMsgAmount:e.needMsgAmount}).then(function(t){var n=[];if(e.processOnlyOneMsg&&t.length>0)for(var r=0;r<t.length;r++){var u=t[r];if("read"!==u.type){t=[u];break}}t.forEach(function(t){n.push(o("processMsg",{msg:t,isNewMsg:!1}))}),Promise.all(n).then(function(){i("markChatHistoryRequestDone",a),s()})},n)):(r&&i("markChatHistoryUnavailable",a),s())})},createStorageData:function(t,e){return new Promise(function(s,n){var i=t.commit;t.dispatch;i("createStorageData",{userId:e.id,userNick:e.user_nick,userCredit:e.user_credit,userStatus:e.user_status,isInBlacklist:"Y"===e.black_status,storeName:e.board_name,unreadMsg:e.unread_count,lastChatTimestamp:e.last_chat_time}),i("addIntoInbox",e.id),s()})},createTempStorageData:function(t,e){return new Promise(function(s,n){var i=t.commit,o=t.dispatch;i("createTempStorageData",{userId:e.userId,unreadMsg:e.unreadMsg,lastChatTimestamp:e.lastChatTimestamp}),i("addIntoInbox",e.id),o("ajaxGetUserAccountInfo",e.userId).then(function(t){i("setUserInfo",t)},function(t){}),s()})},processMsg:function(t,e){return new Promise(function(s,n){var i=t.state,o=t.commit,a=t.dispatch,r=e.msg,u=e.isNewMsg,c=i.userId==r.userid,l=c?r.to[0]:r.userid,g=i.infoMsgCache,d=i.inbox.some(function(t){return t&&t.userId==l}),m=!i.storage.hasOwnProperty(l),h=r.hasOwnProperty("oid")&&""!==r.oid,f=r.hasOwnProperty("pid")&&""!==r.pid,p=h||f,y=l==i.conversation.userId,I=i.finishRetrieveMsgInBuffer,M=p&&(g.hasOwnProperty(r.oid)||g.hasOwnProperty(r.pid)),v=function(){return h?r.oid:f?r.pid:void 0}(),k=function(){var t=String(r.userid+"_"+r.timestamp+"_"+r.oid+r.pid);if(m)return!0;var e=i.storage[l].msgUniqueKeyList;return!e.hasOwnProperty(t)}(),S=function(t,e){for(var s=0;s<t.length;s++)if(t[s].imageid===e)return!0;return!1};if(I){for(var T=!1,R=0;R<i.inbox.length;R++)if(i.inbox[R].userId==l){T=R;break}(T===!1||T>=i.chatListLimit)&&o("addChatListSize",1)}if(m&&a("createTempStorageData",{userId:l,unreadMsg:0,lastChatTimestamp:0}),d||o("addIntoInbox",l),k)switch(r.type){case"delete":o("deleteMsgs",{userId:l,timestamp:r.timestamp}),o("markChatHistoryUnavailable",l),o("deleteContactInInbox",l);break;case"read":Math.floor(r.timestamp)>Math.floor(i.storage[l].lastChatTimestamp)&&u&&c&&o("resetUnreadMsgCounter",l),c||a("updateSeenMsgTimestamp",{userId:l,timestamp:r.timestamp});break;case"text":case"img":case"illegal":p&&(r.info={goodsImgUrl:"",goodsName:"",price:0,transStatus:"",linkUrl:"#"},r.additionalInfoIsReady=!1,M?a("setInfoMsgDataByCache",{key:v,msg:r}):(o("saveInfoMsgCache",{key:v,data:r.info}),y?h?a("ajaxGetTransInfo",r):f&&a("ajaxGetGoodsInfo",r):o("queueInfoMsgRequestTasks",{userId:l,msg:r}))),o(u&&y&&c?"enableAutoScrollChatBox":"disableAutoScrollChatBox"),"img"===r.type&&S(i.storage[l].msgs,r.imageid)?o("updateTempImgMsg",{userId:l,msg:r}):o("addMsg",{userId:l,msg:r}),r.timestamp>i.storage[l].lastChatTimestamp&&o("updateLastChatTimestamp",{userId:l,lastChatTimestamp:r.timestamp}),u&&I&&!c&&(y?a("ajaxSendMsgSeen",l):o("addUnreadCounter",l))}s()})},reSendMsg:function(t,e){for(var s=e.userId,n=e.token,i=t.state.storage[s].msgs,o=0;o<i.length;o++)if(i[o].token===n){var a=i[o],r={userid:a.userid,to:a.to,type:"text",msg:a.msg,time:"",oid:a.oid,pid:a.pid};a.hasOwnProperty("additionalInfoIsReady")&&(r.info=a.info,r.additionalInfoIsReady=a.additionalInfoIsReady),t.commit("removeTempMsg",e),t.dispatch("ajaxSendMsg",r);break}},reSendImgMsg:function(t,e){for(var s=e.userId,n=e.token,i=t.state.storage[s].msgs,o=0;o<i.length;o++)if(i[o].imageid===n){var a=i[o];t.commit("removeTempImgMsg",e),t.dispatch("ajaxSendImgMsg",{userId:s,files:[a.file]});break}},setInfoMsgDataByCache:function(t,e){e.msg.info=t.state.infoMsgCache[e.key]},updateSeenMsgTimestamp:function(t,e){var s=e.userId,n=e.timestamp;n>t.state.storage[s].seenMsgTimestamp&&t.commit("updateSeenMsgTimestamp",e)},loadConversation:function(t,e){var s=t.state,n=t.commit,i=t.dispatch,o=s.conversation.userId!=e,a=s.storage[e].msgs.length,r=s.storage[e].infoMsgsQueue;if(o){var u=s.storage[e],c=s.storage[e].unreadMsg,g=u.msgs[u.msgs.length-1];g&&g.userid!=s.userId;n("resetInfoMsgQueue"),n("loadConversation",e),n("enableAutoScrollChatBox"),i("ajaxGetUserIMStat",{userId:e}),r.forEach(function(t){var e=t.hasOwnProperty("oid")&&""!==t.oid,s=t.hasOwnProperty("pid")&&""!==t.pid;e?i("ajaxGetTransInfo",t):s&&i("ajaxGetGoodsInfo",t)}),n("clearInfoMsgQueue",e),c>0&&i("ajaxSendMsgSeen",e),a<l&&i("initialChatHistoryTask",{userId:u.userId,needMsgAmount:l-a}).then(function(){n("enableForceScrollChatBox")})}},unloadConversation:function(t){t.commit("resetInfoMsgQueue"),t.commit("unloadConversation"),clearTimeout(t.state.userIMStatusRefreshTask)},deleteConversation:function(t,e){t.state.conversation.userId==e&&t.dispatch("unloadConversation"),t.dispatch("ajaxSendDeleteMsg",e),t.dispatch("ajaxDeleteFavorList",e)},checkStorageDataAndLoadConversation:function(t,e){t.state.storage.hasOwnProperty(e)||(t.commit("createTempStorageData",{userId:e,unreadMsg:0,lastChatTimestamp:0}),t.dispatch("ajaxGetUserAccountInfo",e).then(function(s){t.commit("setUserInfo",s),"T"!==t.state.userStatus&&"T"!==t.state.storage[e].userStatus||t.commit("markUserAsNewContact",e)},function(t){})),t.dispatch("loadConversation",e)},sendInfoMsg:function(t,e){var s=void 0!==e.oid,n=void 0!==e.pid,i={userid:t.state.userId,to:[e.userId],type:"text",msg:"",time:"",oid:"",pid:"",info:{goodsImgUrl:"",goodsName:"",price:0,transStatus:"",linkUrl:"#"},additionalInfoIsReady:!1};s?(i.msg="傳送一則訂單訊息",i.oid=e.oid,t.dispatch("ajaxGetTransInfo",i)):n&&(i.msg="傳送一則商品訊息",i.pid=e.pid,t.dispatch("ajaxGetGoodsInfo",i)),t.dispatch("checkStorageDataAndLoadConversation",e.userId),t.commit("queueInfoMsg",i)},chatListShowMore:function(t){return new Promise(function(e,s){t.commit("addChatListSize",t.state.showMoreChatListAmount),e()})},loadChatListChatHistory:function(t){t.getters.chatList.forEach(function(e,s){e.chatHistoryAvailable&&0===e.msgs.length&&t.dispatch("initialChatHistoryTask",{userId:e.userId,needMsgAmount:1,processOnlyOneMsg:!0})})},saveChatListSize:function(t){sessionStorage.M_CHAT_LIST_SIZE=t.state.chatListLimit},setSettingPanelDefaultData:function(t){t.state.settingPanelDataIsReady||(t.commit("setMessengerSwitch",RT.context.messengerOn),t.commit("setAutoReplySwitch",RT.context.autoReplyOn),t.commit("setQuickReplySwitch",RT.context.quickReplyOn),t.commit("markSettingPanelDataReady"))}}});t.exports=S},"./lib/rt_im.js":function(t,e){var s=function(t,e){function s(t){return window.btoa(t).replace(/\+|\/|=/g,"")}function n(t,e){p={resolve:t,reject:e},d.get(l+o+"/msg",h).then(function(e){f=0;var s={};for(var n in e.headers.map)s[n.toLowerCase()]=e.headers.map[n];if(h={before:function(t){i&&i.abort(),i=t},headers:{"Cache-Control":"no-store, no-cache, must-revalidate","If-None-Match":s.etag[0]}},e.body instanceof Blob){var o=new FileReader;o.readAsText(e.body),o.onload=function(e){var s=e.target.result.trim().split("\n");s.forEach(function(t,e){s[e]=JSON.parse(t)}),t(s)}}else{var a=e.body.trim().split("\n");a.forEach(function(t,e){a[e]=JSON.parse(t)}),t(a)}},function(s){m||(504===s.status||410===s.status?f<g?(f++,n(t,e)):y=setTimeout(function(){y=!1,n(t,e)},6e4):401!==s.status&&403!==s.status&&423!==s.status&&451!==s.status&&alert("系統忙碌中，請稍後再試!"))})}Vue.http.headers.common.Accept="application/json",Vue.http.headers.post={"Content-Type":"application/x-www-form-urlencoded"},Vue.http.headers["delete"]={},Vue.http.interceptors.push(function(t,e){t.credentials=!0,e(function(t){0===t.status&&(t.status=504)})});var i,o=Cookies.get("bid_rid"),a="/api/im/v2/index.php",r=e+a,u=r+"/outer/user/"+o,c=t+a+"/outer/user/"+o,l=t+"/api/im/v2/comet/outer/user/",g=5,d=Vue.http,m=!1,h={before:function(t){i=t},headers:{"Cache-Control":"no-store, no-cache, must-revalidate","If-None-Match":String(Date.now())}},f=0,p={},y=!1;return{getStat:function(t){return d.jsonp(r+"/outer/user/stat",{params:{id:t.join()},jsonp:"_callback",jsonpCallback:s(t.join())})},getFavorList:function(t){var e=void 0===t?"":"?q="+t;return d.jsonp(r+"/core/outer/user/"+o+"/favorlist"+e,{jsonp:"_callback",jsonpCallback:s("favorlist"+o)})},addFavorList:function(t){var e=t.join();return d.post(u+"/favorlist",JSON.stringify(t),{params:{id:e}})},deleteFavorList:function(t){var e=t.join();return d["delete"](u+"/favorlist",{params:{id:e}})},receiveMsg:function(){return m=!1,new Promise(n)},stopReceiveMsg:function(){m=!0,i&&i.abort(),h={}},checkReceiveMsgIsWaitingForReconnect:function(){y!==!1&&(clearTimeout(y),y=!1,n(p.resolve,p.reject))},sendMsg:function(t,e){return this.checkReceiveMsgIsWaitingForReconnect(),d.post(c+"/msg",JSON.stringify(e),{params:{to:t}})},sendImgMsg:function(t,e,s){return this.checkReceiveMsgIsWaitingForReconnect(),d.post(c+"/img/"+e+"/msg",s,{params:{to:t}})},deleteMsg:function(t){return d["delete"](c+"/msg",{params:{to:t}})},msgSeen:function(t){return d.post(c+"/msg",JSON.stringify({userid:o,to:[t],type:"read",time:"",oid:"",pid:"",msg:""}),{params:{to:t}})},getChatHistory:function(t,e){return d.jsonp(u+"/log/msg",{params:{to:t,q:e},jsonp:"_callback",jsonpCallback:s(t+e)})},getAutoReplyMsg:function(){return d.jsonp(u+"/sample/msg",{jsonp:"_callback",jsonpCallback:s("sample"+o)})},getQuickReplyMsg:function(){return d.jsonp(u+"/common/msg",{jsonp:"_callback",jsonpCallback:s("common"+o)})}}}(RT.config.im_host,RT.config.rtapi_host);t.exports=s}});